import { ArgsTable, Canvas, Meta, Story } from "@storybook/addon-docs";
import { componentArgs } from "../constants";
import {
  ComponentTitle,
  DarkThemeNotice,
  InstallationInstructions,
  VariantRangeNotice,
  VersionNotice
} from "../../../docs/src/partials";
import { createFilterOptions } from "@mui/material/Autocomplete";
import { name, peerDependencies, version } from "../../package.json";
import { useState } from "react";
import Box from "@mui/material/Box";
import Chip from "@iccc/chip";
import Combobox from "../index.js";
import FormControl from "@mui/material/FormControl";
import FormHelperText from "@mui/material/FormHelperText";
import InputLabel from "@mui/material/InputLabel";
import MenuItem from "@mui/material/MenuItem";
import prettier from "prettier/standalone";
import prettierBabel from "prettier/parser-babel";
import SvgCheckmark from "@iccc/icon/lib/build/ui-controls/checkmark";
import SvgComplete from "@iccc/icon/lib/build/icons/complete";
import SvgCompleteFilled from "@iccc/icon/lib/build/display-icons/complete";
import SvgError from "@iccc/icon/lib/build/display-icons/error";
import SvgGlobe from "@iccc/icon/lib/build/icons/globe";
import SvgIcon from "@mui/material/SvgIcon";
import SvgLink from "@iccc/icon/lib/build/icons/link";
import SvgProfile from "@iccc/icon/lib/build/icons/profile";
import SvgVisible from "@iccc/icon/lib/build/icons/visible";
import TextField from "@mui/material/TextField";
import Typography from "@iccc/typography";

export const top100Films = [
  { title: "The Shawshank Redemption", year: 1994 },
  { title: "The Godfather", year: 1972 },
  { title: "The Godfather: Part II", year: 1974 },
  { title: "The Dark Knight", year: 2008 },
  { title: "12 Angry Men", year: 1957 },
  { title: "Schindler's List", year: 1993 },
  { title: "Pulp Fiction", year: 1994 },
  {
    title: "The Lord of the Rings: The Return of the King",
    year: 2003
  },
  { title: "The Good, the Bad and the Ugly", year: 1966 },
  { title: "Fight Club", year: 1999 },
  {
    title: "The Lord of the Rings: The Fellowship of the Ring",
    year: 2001
  },
  {
    title: "Star Wars: Episode V - The Empire Strikes Back",
    year: 1980
  },
  { title: "Forrest Gump", year: 1994 },
  { title: "Inception", year: 2010 },
  {
    title: "The Lord of the Rings: The Two Towers",
    year: 2002
  },
  { title: "One Flew Over the Cuckoo's Nest", year: 1975 },
  { title: "Goodfellas", year: 1990 },
  { title: "The Matrix", year: 1999 },
  { title: "Seven Samurai", year: 1954 },
  {
    title: "Star Wars: Episode IV - A New Hope",
    year: 1977
  },
  { title: "City of God", year: 2002 },
  { title: "Se7en", year: 1995 },
  { title: "The Silence of the Lambs", year: 1991 },
  { title: "It's a Wonderful Life", year: 1946 },
  { title: "Life Is Beautiful", year: 1997 },
  { title: "The Usual Suspects", year: 1995 },
  { title: "Léon: The Professional", year: 1994 },
  { title: "Spirited Away", year: 2001 },
  { title: "Saving Private Ryan", year: 1998 },
  { title: "Once Upon a Time in the West", year: 1968 },
  { title: "American History X", year: 1998 },
  { title: "Interstellar", year: 2014 },
  { title: "Casablanca", year: 1942 },
  { title: "City Lights", year: 1931 },
  { title: "Psycho", year: 1960 },
  { title: "The Green Mile", year: 1999 },
  { title: "The Intouchables", year: 2011 },
  { title: "Modern Times", year: 1936 },
  { title: "Raiders of the Lost Ark", year: 1981 },
  { title: "Rear Window", year: 1954 },
  { title: "The Pianist", year: 2002 },
  { title: "The Departed", year: 2006 },
  { title: "Terminator 2: Judgment Day", year: 1991 },
  { title: "Back to the Future", year: 1985 },
  { title: "Whiplash", year: 2014 },
  { title: "Gladiator", year: 2000 },
  { title: "Memento", year: 2000 },
  { title: "The Prestige", year: 2006 },
  { title: "The Lion King", year: 1994 },
  { title: "Apocalypse Now", year: 1979 },
  { title: "Alien", year: 1979 },
  { title: "Sunset Boulevard", year: 1950 },
  {
    title:
      "Dr. Strangelove or: How I Learned to Stop Worrying and Love the Bomb",
    year: 1964
  },
  { title: "The Great Dictator", year: 1940 },
  { title: "Cinema Paradiso", year: 1988 },
  { title: "The Lives of Others", year: 2006 },
  { title: "Grave of the Fireflies", year: 1988 },
  { title: "Paths of Glory", year: 1957 },
  { title: "Django Unchained", year: 2012 },
  { title: "The Shining", year: 1980 },
  { title: "WALL·E", year: 2008 },
  { title: "American Beauty", year: 1999 },
  { title: "The Dark Knight Rises", year: 2012 },
  { title: "Princess Mononoke", year: 1997 },
  { title: "Aliens", year: 1986 },
  { title: "Oldboy", year: 2003 },
  { title: "Once Upon a Time in America", year: 1984 },
  { title: "Witness for the Prosecution", year: 1957 },
  { title: "Das Boot", year: 1981 },
  { title: "Citizen Kane", year: 1941 },
  { title: "North by Northwest", year: 1959 },
  { title: "Vertigo", year: 1958 },
  {
    title: "Star Wars: Episode VI - Return of the Jedi",
    year: 1983
  },
  { title: "Reservoir Dogs", year: 1992 },
  { title: "Braveheart", year: 1995 },
  { title: "M", year: 1931 },
  { title: "Requiem for a Dream", year: 2000 },
  { title: "Amélie", year: 2001 },
  { title: "A Clockwork Orange", year: 1971 },
  { title: "Like Stars on Earth", year: 2007 },
  { title: "Taxi Driver", year: 1976 },
  { title: "Lawrence of Arabia", year: 1962 },
  { title: "Double Indemnity", year: 1944 },
  {
    title: "Eternal Sunshine of the Spotless Mind",
    year: 2004
  },
  { title: "Amadeus", year: 1984 },
  { title: "To Kill a Mockingbird", year: 1962 },
  { title: "Toy Story 3", year: 2010 },
  { title: "Logan", year: 2017 },
  { title: "Full Metal Jacket", year: 1987 },
  { title: "Dangal", year: 2016 },
  { title: "The Sting", year: 1973 },
  { title: "2001: A Space Odyssey", year: 1968 },
  { title: "Singin' in the Rain", year: 1952 },
  { title: "Toy Story", year: 1995 },
  { title: "Bicycle Thieves", year: 1948 },
  { title: "The Kid", year: 1921 },
  { title: "Inglourious Basterds", year: 2009 },
  { title: "Snatch", year: 2000 },
  { title: "3 Idiots", year: 2009 },
  { title: "Monty Python and the Holy Grail", year: 1975 }
];

export const filmOptions = top100Films.map((option) => option.title);

<Meta
  args={{
    ...Combobox.defaultProps,
    freeSolo: false,
    layout: "fixed",
    multiple: false
  }}
  argTypes={componentArgs}
  component={Combobox}
  id="components/combobox"
  title="Digital HIG/Components/Combobox"
  parameters={{
    docs: {
      source: {
        type: "code"
      },
      transformSource: (input) =>
        prettier.format(input, {
          parser: "babel",
          plugins: [prettierBabel]
        })
    }
  }}
/>

<ComponentTitle name="Combobox" status="In Progress" />

<code>
  <VersionNotice packageName="combobox" version={version} />
</code>

The Combobox component is a wrapper around the [MUI `<Autocomplete>` component](https://mui.com/material-ui/react-autocomplete/), with Digital HIG defaults.
Additional messaging around the Combobox component is handled using the [MUI `<FormControl>` component](https://mui.com/material-ui/api/form-control/).

For related design documentation, please visit the [Combobox page in the Digital HIG Figma UI Toolkit ](https://www.figma.com/file/Eks986gkqncHjkLnwQjO7g/iccc-sticker-sheets?node-id=4203-241185&t=nHNQYy49yd48qzdE-0).

## Installation

<InstallationInstructions
  componentImport="Combobox"
  name={name}
  peerDependencies={peerDependencies}
/>

## API

- For all supported MUI `<Autocomplete />` props, see [Autocomplete API](https://mui.com/material-ui/api/autocomplete/).
- For all supported MUI `<FormControl />` props, see [FormControl API](https://mui.com/material-ui/api/form-control/).
- For all supported MUI `<FormHelperText/>` props, see [FormHelperText API](https://mui.com/material-ui/api/form-helper-text/).
- For all supported MUI `<InputLabel />` props, see [InputLabel API](https://mui.com/material-ui/api/input-label/).

The `fullWidth` prop may be used as necessary.

<Canvas>
  <Story name="API">
    {(args) => {
      const [value, setValue] = useState([]);
      const renderTags = (value, getTagProps) =>
        args.layout === "grow"
          ? value.map((option, index) => (
              <Chip key={option} label={option} {...getTagProps({ index })} />
            ))
          : [
              <Chip
                key={value[0]}
                {...getTagProps({ index: 0 })}
                label={`${value.length} selected`}
                onDelete={() => setValue([])}
              />
            ];
      const additionalProps = args.multiple
        ? {
            value,
            renderTags,
            onChange: (event, newValue) => setValue(newValue)
          }
        : {};
      return (
        <FormControl fullWidth>
          <Combobox
            {...args}
            options={filmOptions}
            id="combobox-api"
            {...additionalProps}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

<ArgsTable story="API" />

## Combobox variants

Comboboxes provide a way to pick a single option from a group of choices presented as a dropdown list.

Entering text into the combobox input field filters the list of choices presented in the dropdown.

<VariantRangeNotice />

### Free solo

By default, an option from a given set has to be picked. In contrast, the `freeSolo` prop can be used to input arbitrary values, which can then be added to the list of options. One implementation example is shown below, where selecting the "Add..." option will add a typed value to the list of options (adapted from [MUI's "creation" implementation example](https://mui.com/material-ui/react-autocomplete/#creatable)).

<Canvas>
  <Story name="Free solo">
    {() => {
      const filter = createFilterOptions();
      const [value, setValue] = React.useState(null);
      const [options, setOptions] = React.useState(top100Films);
      React.useEffect(() => {
        if (value && value.inputValue) {
          // Create a new value from the user input
          const newOption = {
            title: value.inputValue
          };
          setOptions((previousOptions) => [...previousOptions, newOption]);
        }
      }, [value]);
      return (
        <FormControl fullWidth>
          <InputLabel htmlFor="combobox-free-solo">Free solo</InputLabel>
          <Combobox
            id="combobox-free-solo"
            value={value}
            freeSolo
            onChange={(event, newValue) => {
              if (typeof newValue === "string") {
                // Create a new value from the user input
                const newOption = {
                  title: newValue
                };
                setValue(newOption);
              } else {
                setValue(newValue);
              }
            }}
            filterOptions={(options, params) => {
              const filtered = filter(options, params);
              const { inputValue } = params;
              // Suggest the creation of a new value
              const isExisting = options.some(
                (option) => inputValue === option.title
              );
              if (inputValue !== "" && !isExisting) {
                filtered.push({
                  inputValue,
                  title: `Add "${inputValue}"`
                });
              }
              return filtered;
            }}
            selectOnFocus
            clearOnBlur
            handleHomeEndKeys
            options={options}
            getOptionLabel={(option) => {
              // Value selected with enter, right from the input
              if (typeof option === "string") {
                return option;
              }
              // Add "xxx" option created dynamically
              if (option.inputValue) {
                return option.inputValue;
              }
              // Regular option
              return option.title;
            }}
            renderOption={(props, option) => (
              <li {...props}>{option.title || option}</li>
            )}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

### Features

#### Label and helper text

In this example, the `<InputLabel />` component is used to display the label and the `<Typography />` component with the `variant="smallprint"` is used to display the optional text.
For the helper text, the `<FormHelperText />` component is used.

<Canvas>
  <Story name="Label and helper text">
    <FormControl fullWidth>
      <InputLabel htmlFor="combobox-label">
        Field label
        <Typography variant="smallprint" component="span">
          (optional)
        </Typography>
      </InputLabel>
      <Combobox options={filmOptions} id="combobox-label" />
      <FormHelperText>Helper text</FormHelperText>
    </FormControl>
  </Story>
</Canvas>

#### Rich options

Options can be enriched with several text positions and styles, icons, and/or image thumbnails. This can be achieved using custom composition for the options by leveraging the `renderOption` prop.

<Canvas>
  <Story name="Rich options">
    {() => {
      const options = [
        {
          content: (
            <Box display="flex">
              <Box pr={2}>
                <SvgIcon>
                  <SvgVisible />
                </SvgIcon>
              </Box>
              <Box flexGrow={1}>
                <Typography
                  variant="body-copy-medium"
                  color="ink-on-background"
                >
                  Mauris senectus rhoncus
                </Typography>
                <Typography
                  variant="body-copy-small"
                  color="ink-on-background-60"
                >
                  Mi tristique cursus
                </Typography>
              </Box>
              <Box pr={4}>
                <Typography variant="caption" color="ink-on-background-60">
                  24k
                </Typography>
              </Box>
            </Box>
          ),
          label: "Mauris senectus rhoncus",
          value: 1
        },
        {
          content: (
            <Box display="flex">
              <Box pr={2}>
                <SvgIcon>
                  <SvgGlobe />
                </SvgIcon>
              </Box>
              <Box flexGrow={1}>
                <Typography
                  variant="body-copy-medium"
                  color="ink-on-background"
                >
                  Vulputate sem venenatis
                </Typography>
                <Typography
                  variant="body-copy-small"
                  color="ink-on-background-60"
                >
                  Ultricies est sagittis
                </Typography>
              </Box>
              <Box pr={4}>
                <Typography variant="caption" color="ink-on-background-60">
                  17k
                </Typography>
              </Box>
            </Box>
          ),
          label: "Vulputate sem venenatis",
          value: 2
        },
        {
          content: (
            <Box display="flex">
              <Box pr={2}>
                <SvgIcon>
                  <SvgProfile />
                </SvgIcon>
              </Box>
              <Box flexGrow={1}>
                <Typography
                  variant="body-copy-medium"
                  color="ink-on-background"
                >
                  Rich Options
                </Typography>
                <Typography
                  variant="body-copy-small"
                  color="ink-on-background-60"
                >
                  Nibh vulputate nec
                </Typography>
              </Box>
              <Box pr={4}>
                <Typography variant="caption" color="ink-on-background-60">
                  131k
                </Typography>
              </Box>
            </Box>
          ),
          label: "Rich options",
          value: 3
        },
        {
          content: (
            <Box display="flex">
              <Box pr={2}>
                <SvgIcon>
                  <SvgLink />
                </SvgIcon>
              </Box>
              <Box flexGrow={1}>
                <Typography
                  variant="body-copy-medium"
                  color="ink-on-background"
                >
                  Pulvinar facilisis felis
                </Typography>
                <Typography
                  variant="body-copy-small"
                  color="ink-on-background-60"
                >
                  Vulputate nibh neque
                </Typography>
              </Box>
              <Box pr={4}>
                <Typography variant="caption" color="ink-on-background-60">
                  1.5k
                </Typography>
              </Box>
            </Box>
          ),
          label: "Pulvinar facilisis felis",
          value: 4
        },
        {
          content: (
            <Box display="flex">
              <Box pr={2}>
                <SvgIcon>
                  <SvgComplete />
                </SvgIcon>
              </Box>
              <Box flexGrow={1}>
                <Typography
                  variant="body-copy-medium"
                  color="ink-on-background"
                >
                  Enim faucibus adipiscing
                </Typography>
                <Typography
                  variant="body-copy-small"
                  color="ink-on-background-60"
                >
                  Mi tristique cursus
                </Typography>
              </Box>
              <Box pr={4}>
                <Typography variant="caption" color="ink-on-background-60">
                  440k
                </Typography>
              </Box>
            </Box>
          ),
          label: "Enim faucibus adipiscing",
          value: 5
        }
      ];
      return (
        <FormControl fullWidth>
          <InputLabel htmlFor="combobox-rich-options">Features</InputLabel>
          <Combobox
            id="combobox-rich-options"
            options={options}
            renderOption={(props, option, state) => {
              return (
                <MenuItem key={option.value} value={option.value} {...props}>
                  <>
                    <Box width="100%" mr={6}>
                      {option.content}
                    </Box>
                    {state.selected && (
                      <SvgIcon
                        title="Selected"
                        sx={{
                          position: "absolute",
                          top: "12px",
                          right: "12px"
                        }}
                      >
                        <SvgCheckmark />
                      </SvgIcon>
                    )}
                  </>
                </MenuItem>
              );
            }}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

#### Categories

Options can be visually grouped into categories with category titles using MUI's `groupBy` prop.

Note: In this particular example, the `options` array contains objects in the format `{ title: "To Kill a Mockingbird", year: 1962 }`.

<Canvas>
  <Story name="Categories">
    <FormControl fullWidth>
      <InputLabel htmlFor="combobox-categories">Categories</InputLabel>
      <Combobox
        id="combobox-categories"
        options={top100Films.sort((a, b) => a.year - b.year)}
        groupBy={(option) => option.year}
        getOptionLabel={(option) => option.title}
        renderOption={(props, option, state) => (
          <Box component="li" {...props} key={option.title}>
            {option.title}
            {state.selected && (
              <SvgIcon className="DhigCombobox--checkedIcon">
                <SvgCheckmark />
              </SvgIcon>
            )}
          </Box>
        )}
      />
    </FormControl>
  </Story>
</Canvas>

#### Addendum

Explanatory text or contextual links can be added to a dropdown as an addendum using the `addendum` prop. The addendum is not selectable.

<Canvas>
  <Story name="Addendum">
    <FormControl fullWidth>
      <InputLabel htmlFor="combobox-addendum">Addendum</InputLabel>
      <Combobox
        id="combobox-addendum"
        options={filmOptions}
        addendum="Addendum. Cursus venenatis convallis consectetur fermentum. Faucibus malesuada mauris et, amet neque sed sit pulvinar eget."
      />
    </FormControl>
  </Story>
</Canvas>

#### Placeholder

Use the `placeholder` prop on the `<Combobox />` component to set the placeholder inside of the field

<Canvas>
  <Story name="Placeholder">
    <FormControl fullWidth>
      <InputLabel htmlFor="combobox-placeholder">
        Field label
        <Typography variant="smallprint" component="span">
          (optional)
        </Typography>
      </InputLabel>
      <Combobox
        options={filmOptions}
        id="combobox-placeholder"
        placeholder="Placeholder text"
      />
      <FormHelperText>Helper text</FormHelperText>
    </FormControl>
  </Story>
</Canvas>

### States

#### Success

Use the `success` prop on the form control element to set the success state and styles to the field

<Canvas>
  <Story name="Success">
    <FormControl fullWidth color="success">
      <InputLabel htmlFor="combobox-success">
        Field label
        <Typography variant="smallprint" component="span">
          (optional)
        </Typography>
      </InputLabel>
      <Combobox options={filmOptions} id="combobox-success" />
      <FormHelperText>
        <SvgIcon>
          <SvgCompleteFilled />
        </SvgIcon>
        Success message
      </FormHelperText>
    </FormControl>
  </Story>
</Canvas>

#### Error

Use the `error` prop on the form control element and in the `<Combobox />` component to set the error state and styles to the field

<Canvas>
  <Story name="Error">
    <FormControl fullWidth error>
      <InputLabel htmlFor="combobox-error">
        Field label
        <Typography variant="smallprint" component="span">
          (optional)
        </Typography>
      </InputLabel>
      <Combobox options={filmOptions} id="combobox-error" error />
      <FormHelperText>
        <SvgIcon>
          <SvgError />
        </SvgIcon>
        Error message
      </FormHelperText>
    </FormControl>
  </Story>
</Canvas>

#### Disabled

You can use the `disabled` prop in `<FormControl />` and in `<Combobox />` components

<Canvas>
  <Story name="Disabled">
    <FormControl fullWidth disabled>
      <InputLabel htmlFor="combobox-disabled">Disabled</InputLabel>
      <Combobox options={filmOptions} id="combobox-disabled" disabled />
    </FormControl>
  </Story>
</Canvas>

### Multi-select

All multi-select options are available through the use of MUI's `multiple` prop.

#### Fixed layout

Use the `layout="fixed"` prop for this behaviour. Update the `renderTags` function so that only one chip is displayed in the field at a time. The field height of one row stays the same, and the dropdown reveals the selected options.

<Canvas>
  <Story name="Multi-select: fixed">
    {() => {
      const [value, setValue] = useState([filmOptions[0], filmOptions[10]]);
      const [inputValue, setInputValue] = useState("");
      return (
        <FormControl fullWidth>
          <InputLabel htmlFor="combobox-multi-select-fixed">Fixed</InputLabel>
          <Combobox
            value={value}
            id="combobox-multi-select-fixed"
            multiple
            layout="fixed"
            options={filmOptions}
            inputValue={inputValue}
            onChange={(event, newValue) => {
              setValue(newValue);
            }}
            onInputChange={(event, newInputValue) => {
              setInputValue(newInputValue);
            }}
            renderTags={(value, getTagProps) => [
              <Chip
                key={value[0]}
                {...getTagProps({ index: 0 })}
                label={`${value.length} selected`}
                onDelete={() => setValue([])}
              />
            ]}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

#### Grow layout

Use the `layout="grow"` prop for this behaviour. This layout is intended to display one chip for each selected option. The field grows and shrinks in height to accommodate all chips.

<Canvas>
  <Story name="Multi-select: grow">
    {() => {
      const slicedFilmOptions = filmOptions.slice(0, 10);
      const preselectedOptions = [slicedFilmOptions[0], slicedFilmOptions[1]];
      return (
        <FormControl fullWidth>
          <InputLabel htmlFor="combobox-multi-select-grow">Grow</InputLabel>
          <Combobox
            id="combobox-multi-select-grow"
            multiple
            layout="grow"
            options={slicedFilmOptions}
            renderTags={(value, getTagProps) =>
              value.map((option, index) => (
                <Chip key={option} label={option} {...getTagProps({ index })} />
              ))
            }
            defaultValue={preselectedOptions}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

### Render input

You can extend the funcionality of the `<Combobox />` passing a custom `renderInput` prop, for more reference you can visit [Autocomplete API](https://mui.com/material-ui/api/autocomplete/).

<Canvas>
  <Story name="Render input">
    {() => {
      return (
        <FormControl fullWidth>
          <InputLabel htmlFor="combobox-render-input">Render input</InputLabel>
          <Combobox
            id="combobox-render-input"
            options={filmOptions}
            renderInput={(props) => {
              return <TextField variant="standard" {...props} />;
            }}
          />
        </FormControl>
      );
    }}
  </Story>
</Canvas>

### Dark theme

<DarkThemeNotice />

<Canvas>
  <Story name="Dark theme" parameters={{ theme: "dark" }}>
    <FormControl fullWidth>
      <InputLabel htmlFor="combobox-dark-theme">Dark theme</InputLabel>
      <Combobox
        options={filmOptions}
        id="combobox-dark-theme"
        multiple
        layout="fixed"
        renderTags={(value, getTagProps) => [
          <Chip
            key={value[0]}
            {...getTagProps({ index: 0 })}
            label={`${value.length} selected`}
          />
        ]}
        defaultValue={[filmOptions[0], filmOptions[10]]}
      />
    </FormControl>
  </Story>
</Canvas>
