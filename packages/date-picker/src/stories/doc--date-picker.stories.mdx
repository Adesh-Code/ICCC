import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { Canvas, Meta, Story } from "@storybook/addon-docs";
import { Calendar, CaretDown, Checkmark } from "@iccc/icon";
import {
  ComponentTitle,
  DarkThemeNotice,
  InstallationInstructions,
  MuiLink
} from "../../../docs/src/partials";
import {
  DatePicker,
  DateRangePicker,
  StaticDateRangePicker
} from "@mui/x-date-pickers-pro";
import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { peerDependencies } from "../../package.json";
import { setLicenseKey } from "@iccc/theme-mui";
import Box from "@mui/material/Box";
import Button from "@mui/material/Button";
import dayjs from "dayjs";
import ErrorIcon from "@iccc/icon/lib/build/display-icons/error";
import FormControl from "@mui/material/FormControl";
import FormHelperText from "@mui/material/FormHelperText";
import InputLabel from "@mui/material/InputLabel";
import MenuItem from "@mui/material/MenuItem";
import Popover from "@mui/material/Popover";
import prettier from "prettier/standalone";
import prettierBabel from "prettier/parser-babel";
import SvgIcon from "@mui/material/SvgIcon";

<Meta
  id="components/date-picker"
  title="Digital HIG/Components/Date picker"
  parameters={{
    docs: {
      source: {
        type: "code"
      },
      transformSource: (input) =>
        prettier.format(input, {
          parser: "babel",
          plugins: [prettierBabel]
        })
    },
    vr: false
  }}
/>

<ComponentTitle name="Date picker" status="Stable" />

<code>
  <MuiLink
    componentName="Date picker"
    link="https://mui.com/x/react-date-pickers/date-picker/"
  />
</code>

Date pickers let the user choose a date.

For related design documentation, please see the Digital HIG [Figma UI Toolkit](https://www.figma.com/file/Eks986gkqncHjkLnwQjO7g/iccc-sticker-sheets?type=design&node-id=7505-393760&mode=design&t=2giQLn1c130rurqN-0).

## Installation

<InstallationInstructions peerDependencies={peerDependencies} />

```bash
yarn add @mui/x-date-pickers @mui/x-date-pickers-pro
```

## Setup

MUI supports four different date libraries:

- [Day.js](https://day.js.org/)
- [date-fns](https://date-fns.org/)
- [Luxon](https://moment.github.io/luxon/#/)
- [moment.js](https://momentjs.com/)

First, you have to choose and install the adapter package for the date-library you want to use. For example, to install day.js:

```bash
yarn add dayjs
```

Then you have to set the `dateAdapter` prop of the `LocalizationProvider` accordingly:

```jsx
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { DatePicker } from "@mui/x-date-pickers";
import InputLabel from "@mui/material/InputLabel";
import FormControl from "@mui/material/FormControl";

const MyDatePicker = () => (
  <LocalizationProvider dateAdapter={AdapterDayjs}>
    <FormControl>
      <InputLabel htmlFor="date-picker-id">Label</InputLabel>
      <DatePicker id="date-picker-id" />
    </FormControl>
  </LocalizationProvider>
);
```

See [complete installation instructions in the MUI docs](https://mui.com/x/react-date-pickers/getting-started/#setup).

Note: The format of the date picker can be [customized using the `format` prop.](https://mui.com/x/react-date-pickers/adapters-locale/#custom-field-format)

## API

- For `AdapterDayjs` documentation, see [AdapterDayjs](https://mui.com/x/react-date-pickers/adapters-locale/#with-dayjs)
- For all supported MUI `<DatePicker />` props, see [DatePicker API](https://mui.com/x/react-date-pickers/date-picker/)
- For all supported MUI `<DateRangePicker />` props, see [DateRangePicker API](https://mui.com/x/react-date-pickers/date-range-picker/)
- For all supported MUI `<FormControl />` props, see [FormControl API](https://mui.com/material-ui/api/form-control/).
- For all supported MUI `<FormHelperText/>` props, see [FormHelperText API](https://mui.com/material-ui/api/form-helper-text/).
- For all supported MUI `<InputLabel />` props, see [InputLabel API](https://mui.com/material-ui/api/input-label/).
- For all supported MUI `<LocalizationProvider />` props, see [LocalizationProvider API](https://mui.com/x/api/date-pickers/localization-provider/).

## Date picker states

### Default

<Canvas>
  <Story name="Default">
    {() => {
      const [value, setValue] = React.useState(null);
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl>
            <InputLabel htmlFor="date-picker-id-default">Default</InputLabel>
            <DatePicker
              id="date-picker-id-default"
              onChange={handleChange}
              value={value}
            />
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Error

Communicates to the user that the current selection is an error.

<Canvas>
  <Story name="Error">
    {() => {
      const [value, setValue] = React.useState(dayjs().add(1, "day"));
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl error>
            <InputLabel htmlFor="date-picker-id-error">Error</InputLabel>
            <DatePicker
              id="date-picker-id-error"
              value={value}
              onChange={handleChange}
              disableFuture
            />
            <FormHelperText>
              <SvgIcon id="dhig--ui-controls--error" title="Error">
                <ErrorIcon />
              </SvgIcon>
              Error
            </FormHelperText>
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Disabled

<Canvas>
  <Story name="Disabled">
    {() => {
      const [value, setValue] = React.useState(null);
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl disabled>
            <InputLabel htmlFor="date-picker-id-disabled">Disabled</InputLabel>
            <DatePicker
              id="date-picker-id-disabled"
              disabled
              value={value}
              onChange={handleChange}
            />
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Disabled future dates

Demonstrating how to use out-of-the-box MUI `disableFuture` API to disable future dates

<Canvas>
  <Story name="Disabled dates">
    {() => {
      const [value, setValue] = React.useState(null);
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl>
            <InputLabel htmlFor="date-picker-id-disabled-dates">
              Disabled dates
            </InputLabel>
            <DatePicker
              id="date-picker-id-disabled-dates"
              disableFuture
              value={value}
              onChange={handleChange}
            />
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Dark theme

<DarkThemeNotice />

<Canvas>
  <Story name="Dark theme" parameters={{ theme: "dark" }}>
    {() => {
      const [value, setValue] = React.useState(null);
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl>
            <InputLabel htmlFor="date-picker-id-default">Default</InputLabel>
            <DatePicker
              id="date-picker-id-default"
              onChange={handleChange}
              value={value}
            />
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Date range picker

The date range picker lets the user select a range of dates.

Same installation instructions as indicated above apply, except for substituting the MUI component import:

```jsx
import { AdapterDayjs } from "@mui/x-date-pickers/AdapterDayjs";
import { LocalizationProvider } from "@mui/x-date-pickers/LocalizationProvider";
import { DateRangePicker } from "@mui/x-date-pickers-pro";
import FormControl from "@mui/material/FormControl";
```

Please note: In order to use a [date range picker component](https://mui.com/x/react-date-pickers/date-range-picker/), the MUI X Pro license needs to be set:

```jsx
import { setLicenseKey } from "@iccc/theme-mui";
setLicenseKey();
```

<Canvas>
  <Story name="Date range picker">
    {() => {
      setLicenseKey();
      const [value, setValue] = React.useState([null, null]);
      const handleChange = (value) => {
        setValue(value);
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <FormControl>
            <InputLabel htmlFor="date-range-picker">Date range</InputLabel>
            <DateRangePicker
              id="date-range-picker"
              value={value}
              onChange={handleChange}
            />
          </FormControl>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>

### Date range picker with shortcuts

The date range picker can also be used with shortcuts. Below is one possible implementation example, with the following additional imports:

```jsx
import { StaticDateRangePicker } from "@mui/x-date-pickers-pro";
import MenuItem from "@mui/material/MenuItem";
import Popover from "@mui/material/Popover";
```

For more information about shortcuts, [see the relevant MUI docs](https://mui.com/x/react-date-pickers/shortcuts/).

<Canvas>
  <Story
    name="Date range picker with shortcuts"
    parameters={{ style: { height: 350 } }}
  >
    {() => {
      setLicenseKey();
      const [anchorEl, setAnchorEl] = React.useState(null);
      const [buttonLabel, setButtonLabel] = React.useState("Select date range");
      const [selectedValue, setSelectedValue] = React.useState([null, null]);
      const handleClick = (event) => {
        setAnchorEl(event.currentTarget);
      };
      const handleClose = () => {
        setAnchorEl(null);
      };
      const shortcutsItems = [
        {
          label: "This week",
          getValue: () => {
            const today = dayjs();
            return [today.startOf("week"), today.endOf("week")];
          }
        },
        {
          label: "Last week",
          getValue: () => {
            const today = dayjs();
            const prevWeek = today.subtract(7, "day");
            return [prevWeek.startOf("week"), prevWeek.endOf("week")];
          }
        },
        {
          label: "Last 7 days",
          getValue: () => {
            const today = dayjs();
            return [today.subtract(7, "day"), today];
          }
        },
        {
          label: "Current month",
          getValue: () => {
            const today = dayjs();
            return [today.startOf("month"), today.endOf("month")];
          }
        },
        {
          label: "Next month",
          getValue: () => {
            const today = dayjs();
            const startOfNextMonth = today.endOf("month").add(1, "day");
            return [startOfNextMonth, startOfNextMonth.endOf("month")];
          }
        },
        {
          label: "Custom",
          getValue: () => [null, null]
        }
      ];
      const areDateRangesEqual = (range1, range2) => {
        // Compare two date ranges based on date alone (reset time)
        const [start1, end1] = range1.map((dateString) =>
          new Date(dateString).setHours(0, 0, 0, 0)
        );
        const [start2, end2] = range2.map((dateString) =>
          new Date(dateString).setHours(0, 0, 0, 0)
        );
        return start1 === start2 && end1 === end2;
      };
      const updateButtonLabel = (dateRange) => {
        // Update button label with formatted selected date range if custom
        // and with selected shortcut label if not
        let buttonLabel = "Select date range";
        if (!dateRange[0] || !dateRange[1]) {
          setButtonLabel(buttonLabel);
          return;
        }
        const dateRangeShortcutItem = shortcutsItems.find((shortcut) => {
          const [start, end] = shortcut.getValue();
          return areDateRangesEqual(dateRange, [start, end]);
        });
        if (dateRangeShortcutItem) {
          buttonLabel = dateRangeShortcutItem.label;
        } else {
          const [startDate, endDate] = dateRange.map(
            (dateString) => new Date(dateString)
          );
          const startMonth = startDate.toLocaleString("en-US", {
            month: "short"
          });
          const endMonth = endDate.toLocaleString("en-US", { month: "short" });
          if (startMonth === endMonth) {
            buttonLabel = `${startMonth} ${startDate.getDate()}-${endDate.getDate()}`;
          } else {
            const formattedStart = `${startMonth} ${startDate.getDate()}`;
            const formattedEnd = `${endMonth} ${endDate.getDate()}`;
            buttonLabel = `${formattedStart} - ${formattedEnd}`;
          }
        }
        setButtonLabel(buttonLabel);
      };
      const CustomRangeShortcuts = ({
        // Custom slot for shortcuts, using menu items instead of chips
        className,
        items,
        onChange,
        isValid
      }) => {
        if (items === null || items.length === 0) {
          return null;
        }
        const resolvedItems = items.map((item) => {
          // Assign correct attributes to shortcut items
          const newValue = item.getValue({ isValid });
          let selected;
          if (item.label === "Custom") {
            selected = !shortcutsItems.some((shortcut) => {
              const [start, end] = shortcut.getValue();
              return areDateRangesEqual(selectedValue, [start, end]);
            });
          } else {
            selected = areDateRangesEqual(selectedValue, newValue);
          }
          return {
            label: item.label,
            onClick: () => {
              onChange(newValue);
            },
            disabled: !isValid(newValue),
            selected
          };
        });
        return (
          <Box
            className={className}
            component="ul"
            sx={{
              padding: (theme) => theme.primitives.spacings["0"],
              margin: "2px 0px",
              borderRight: (theme) =>
                `${theme.primitives.borderWidths.medium} solid ${theme.tokens.colors["divider-0"]}`,
              "& [class*='MuiMenuItem-root']": {
                alignItems: "center",
                flexWrap: "wrap",
                justifyContent: "space-between",
                padding: (theme) => `10px ${theme.primitives.spacings["3"]}`,
                "& svg": {
                  paddingRight: (theme) => theme.primitives.spacings["0"],
                  paddingLeft: (theme) => theme.primitives.spacings["2"]
                }
              }
            }}
          >
            {resolvedItems.map((item) => (
              <MenuItem key={item.label} {...item} tabIndex={0}>
                {item.label}
                <SvgIcon
                  title="selected"
                  style={
                    item.selected
                      ? { visibility: "visible" }
                      : { visibility: "hidden" }
                  }
                >
                  <Checkmark />
                </SvgIcon>
              </MenuItem>
            ))}
          </Box>
        );
      };
      return (
        <LocalizationProvider dateAdapter={AdapterDayjs}>
          <Button
            onClick={handleClick}
            variant="outlined"
            startIcon={
              <SvgIcon fontSize="medium">
                <Calendar />
              </SvgIcon>
            }
            endIcon={
              <SvgIcon fontSize="medium">
                <CaretDown />
              </SvgIcon>
            }
          >
            {buttonLabel}
          </Button>
          <Popover
            open={!!anchorEl}
            anchorEl={anchorEl}
            onClose={handleClose}
            anchorOrigin={{ vertical: "bottom", horizontal: "left" }}
          >
            <StaticDateRangePicker
              value={selectedValue}
              id="date-range-picker-with-shortcuts"
              onChange={(newValue) => {
                setSelectedValue(newValue);
                updateButtonLabel(newValue);
              }}
              slots={{
                shortcuts: CustomRangeShortcuts
              }}
              slotProps={{
                shortcuts: {
                  items: shortcutsItems
                },
                actionBar: { actions: [] },
                toolbar: { sx: { display: "none" } }
              }}
              calendars={2}
            />
          </Popover>
        </LocalizationProvider>
      );
    }}
  </Story>
</Canvas>
